{% extends 'tasks/base.html' %}
{% load static %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <h2 class="mb-4">{% if form.instance.pk %}Edit Task{% else %}Create New Task{% endif %}</h2>

    <form method="POST" action="{% if form.instance.pk %}{% url 'task_edit' form.instance.pk %}{% else %}{% url 'task_create' %}{% endif %}">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}

      <div class="mb-3">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.errors %}<div class="text-danger">{{ form.title.errors }}</div>{% endif %}
      </div>

      <div class="mb-3">
        {{ form.description.label_tag }}
        {{ form.description }}
        {% if form.description.errors %}<div class="text-danger">{{ form.description.errors }}</div>{% endif %}
      </div>

      <div class="mb-3 form-check">
        {{ form.completed }}
        {{ form.completed.label_tag }}
        {% if form.completed.errors %}<div class="text-danger">{{ form.completed.errors }}</div>{% endif %}
      </div>

      <div class="mb-3">
        {{ form.due_date.label_tag }}
        {{ form.due_date }}
        {% if form.due_date.errors %}<div class="text-danger">{{ form.due_date.errors }}</div>{% endif %}
      </div>

      <div class="mb-3">
        <label for="recipients" class="form-label">Assign To</label>
        <select name="recipients" id="recipients" class="form-select" multiple size="5">
          {% for user in users %}
            {% if form.instance.pk %}
              <option value="{{ user.id }}" {% if user in form.instance.recipients.all %}selected{% endif %}>
                {{ user.username }}
              </option>
            {% else %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <small class="form-text text-muted">Hold CTRL (or CMD on Mac) to select multiple users.</small>
      </div>

      <button type="submit" class="btn btn-primary w-100 mb-2" name="{% if form.instance.pk %}update_task{% else %}create_task{% endif %}">
        {% if form.instance.pk %}Update Task{% else %}Assign Task{% endif %}
      </button>
    </form>

    {% if form.instance.pk and request.user.role in "supervisor admin hod" %}
      <button type="button" class="btn btn-success w-100 mt-3" data-bs-toggle="modal" data-bs-target="#sendEmailModal">
        Send Email Notification
      </button>
    {% endif %}

    {% if form.instance.pk %}
    <div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="{% url 'task_edit' form.instance.pk %}">
            {% csrf_token %}
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="sendEmailModalLabel">Compose Email</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">From</label>
                <input type="text" class="form-control" value="{{ request.user.username }} <{{ request.user.email }}>" disabled>
              </div>

              <div class="mb-3">
                <label class="form-label">To</label>
                <select name="recipients" class="form-select" multiple size="5">
                  {% for user in users %}
                    {% if user.email %}
                      <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Hold CTRL (or CMD on Mac) to select multiple recipients.</small>
              </div>

              <div class="mb-3">
                <label for="email_template" class="form-label">Email Template</label>
                <select name="email_template" id="email_template" class="form-select">
                  <option value="">-- Select a Template --</option>
                  {% for template in email_templates %}
                    <option value="{{ template.id }}" data-subject="{{ template.subject|escape }}" data-body="{{ template.body|escape }}">
                      {{ template.subject }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <input type="text" class="form-control" id="custom_subject" name="custom_subject" placeholder="Subject">
              </div>

              <div class="mb-3">
                <textarea class="form-control" id="custom_message" name="custom_message" rows="12" placeholder="Write your message..."></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Discard</button>
              <button type="submit" class="btn btn-primary" name="send_email">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <a href="{% url 'dashboard' %}" class="btn btn-link mt-3">Back to Dashboard</a>
  </div>
</div>

<script>
  // Auto-fill subject and body when template is selected
  const templateSelect = document.getElementById("email_template");
  const subjectInput = document.getElementById("custom_subject");
  const messageInput = document.getElementById("custom_message");

  if(templateSelect){
    templateSelect.addEventListener("change", function(){
      const selectedOption = this.options[this.selectedIndex];
      if(selectedOption && selectedOption.value){
        subjectInput.value = selectedOption.dataset.subject || "";
        messageInput.value = selectedOption.dataset.body || "";
      } else {
        subjectInput.value = "";
        messageInput.value = "";
      }
    });
  }
</script>

{% endblock %}
